{% extends 'book_ai/base.html' %}
{% load math_filters %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar with improved UI -->
        <div class="col-lg-3 col-md-4">
            <div class="sticky-top" style="top: 20px; z-index: 100;">
                <!-- Book Information Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 fw-bold">
                            <i class="fas fa-book text-primary me-2"></i>Book Details
                        </h5>
                        
                        <a href="{% url 'home' %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Back to Library">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <h6 class="fw-bold book-title mb-3">{{ book.title }}</h6>
                        
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-file-alt me-2 text-secondary"></i>
                                <span class="text-muted">{{ book.page_count }} pages</span>
                            </div>
                            <div>
                                <i class="fas fa-clock me-2 text-secondary"></i>
                                <span class="text-muted">~{{ book.page_count|intdiv:2 }} min</span>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#apiSettingsModal">
                                <i class="fas fa-cogs me-1"></i> AI Settings
                            </button>
                            <a href="#ask" class="btn btn-sm btn-outline-success smooth-scroll">
                                <i class="fas fa-question-circle me-1"></i> Ask Question
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced TOC Section -->
                <div class="card border-0 shadow-sm mb-4" id="toc-card">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="fas fa-list-alt text-primary me-2"></i>Table of Contents
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu shadow-sm">
                                    <li><a class="dropdown-item" href="#" onclick="expandAllTOC()"><i class="fas fa-expand-arrows-alt me-2"></i>Expand All</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="collapseAllTOC()"><i class="fas fa-compress-arrows-alt me-2"></i>Collapse All</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="showTOCStats()"><i class="fas fa-chart-bar me-2"></i>TOC Statistics</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- TOC Search -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="toc-search" placeholder="Search chapters..." onkeyup="filterTOC()">
                                <button class="btn btn-outline-secondary" onclick="clearTOCSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- TOC Statistics (collapsible) -->
                        <div class="collapse mb-3" id="tocStats">
                            <div class="card card-body mb-2" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <strong class="text-primary">{{ toc_stats.total_chapters }}</strong>
                                            <small class="d-block text-muted">Chapters</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <strong class="text-success">{{ toc_stats.max_depth }}</strong>
                                        <small class="d-block text-muted">Max Depth</small>
                                    </div>
                                </div>
                                <div class="row text-center mt-2">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <strong class="text-warning">{{ toc_stats.total_pages_covered }}</strong>
                                            <small class="d-block text-muted">Pages</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <strong class="text-info">{{ toc_stats.avg_chapter_length|floatformat:1 }}</strong>
                                        <small class="d-block text-muted">Avg Length</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Hierarchical TOC -->
                    <div class="toc-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; background: #fff;">
                        <div class="list-group list-group-flush" id="toc-list">
                            <!-- All Chapters Option -->
                            <a href="#" class="list-group-item list-group-item-action toc-item" 
                               data-chapter-id="" 
                               data-level="0"
                               onclick="selectChapter(event, '', 'All Chapters')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-book text-primary me-2"></i>
                                        <strong>All Chapters</strong>
                                    </div>
                                    <span class="badge bg-primary">{{ book.page_count }} pages</span>
                                </div>
                            </a>
                            
                            <!-- Dynamic TOC Structure -->
                            {% for chapter in toc_structure %}
                                <div class="toc-chapter-group" data-level="{{ chapter.level }}">
                                    <a href="#" class="list-group-item list-group-item-action toc-item" 
                                       data-chapter-id="{{ chapter.id }}"
                                       data-level="{{ chapter.level }}"
                                       data-title="{{ chapter.title }}"
                                       data-start-page="{{ chapter.start_page }}"
                                       data-end-page="{{ chapter.end_page }}"
                                       onclick="selectChapter(event, {{ chapter.id }}, '{{ chapter.title }}')">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="toc-content" style="margin-left: {% with level_minus_one=chapter.level|add:'-1' %}{{ level_minus_one|mul:'20' }}{% endwith %}px;">
                                                {% if chapter.children %}
                                                    <i class="fas fa-chevron-right toc-toggle me-2" onclick="toggleTOCSection(event, this)"></i>
                                                {% else %}
                                                    <i class="fas fa-file-alt text-muted me-2"></i>
                                                {% endif %}
                                                <span class="toc-title">{{ chapter.title }}</span>
                                                {% if chapter.level > 1 %}
                                                    <small class="text-muted ms-1">(Level {{ chapter.level }})</small>
                                                {% endif %}
                                            </div>
                                            <div class="toc-meta">
                                                <small class="text-muted">
                                                    {% if chapter.start_page and chapter.end_page %}
                                                        p{{ chapter.start_page }}-{{ chapter.end_page }}
                                                    {% endif %}
                                                    <span class="badge bg-light text-dark ms-1">{{ chapter.page_count }} pg{{ chapter.page_count|pluralize }}</span>
                                                </small>
                                            </div>
                                        </div>
                                    </a>
                                    
                                    <!-- Children (initially collapsed) -->
                                    {% if chapter.children %}
                                        <div class="toc-children collapse">
                                            {% for child in chapter.children %}
                                                <a href="#" class="list-group-item list-group-item-action toc-item toc-child" 
                                                   data-chapter-id="{{ child.id }}"
                                                   data-level="{{ child.level }}"
                                                   data-title="{{ child.title }}"
                                                   data-start-page="{{ child.start_page }}"
                                                   data-end-page="{{ child.end_page }}"
                                                   onclick="selectChapter(event, {{ child.id }}, '{{ child.title }}')">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="toc-content" style="margin-left: {% with level_minus_one=child.level|add:'-1' %}{{ level_minus_one|mul:'20' }}{% endwith %}px;">
                                                            <i class="fas fa-circle text-secondary me-2" style="font-size: 6px; vertical-align: middle;"></i>
                                                            <span class="toc-title">{{ child.title }}</span>
                                                            <small class="text-muted ms-1">({{ child.level }}.{{ forloop.counter }})</small>
                                                        </div>
                                                        <div class="toc-meta">
                                                            <small class="text-muted">
                                                                {% if child.start_page and child.end_page %}
                                                                    p{{ child.start_page }}-{{ child.end_page }}
                                                                {% endif %}
                                                                <span class="badge bg-light text-dark ms-1">{{ child.page_count }} pg{{ child.page_count|pluralize }}</span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                      <!-- Frequent Questions -->
                    <div id="frequent-questions" class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="fas fa-fire text-warning me-1"></i>Popular Questions
                            </h6>
                            <small class="text-muted" id="question-count">0 questions</small>
                        </div>
                        <div id="questions-list" class="mt-2">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-question-circle fa-2x mb-2 text-muted"></i>
                                <p class="mb-1">Select a chapter to see popular questions</p>
                                <small>Questions from other learners will appear here</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
          <!-- Main Content Area with Enhanced UI -->
        <div class="col-lg-9 col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-bold">
                                    <i class="fas fa-book-open me-2"></i><span id="current-chapter">All Chapters</span>
                                </span>
                            </div>
                            <span id="chapter-badge" class="badge bg-primary px-3 py-2 rounded-pill">General</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span id="question-counter" class="badge bg-light text-dark px-3 py-2 rounded-pill">
                                <i class="fas fa-comment-dots me-1"></i> <span>0</span> questions asked
                            </span>
                            <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="clearChat()" data-bs-toggle="tooltip" title="Clear conversation">
                                <i class="fas fa-trash me-1"></i> Clear Chat
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Chat Area with improved design -->
                    <div id="chat-messages" class="chat-container p-4" style="height: 550px; overflow-y: auto; background-color: #f8fafc;">
                        <div class="text-center py-5" id="welcome-message">
                            <div class="welcome-animation mb-4">
                                <div class="ai-avatar mb-3">
                                    <i class="fas fa-robot fa-4x text-primary" style="opacity: 0.8;"></i>
                                    <div class="pulse-ring"></div>
                                </div>
                                <h3 class="text-primary fw-bold">Welcome to Your Book AI Assistant!</h3>
                                <p class="lead text-secondary">I'll help you explore and understand "{{ book.title }}"</p>
                            </div>
                            
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-body p-4">
                                            <h5 class="card-title text-primary fw-bold">
                                                <i class="fas fa-graduation-cap me-2"></i>How I Can Help You Learn
                                            </h5>
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <div class="feature-item mb-3">
                                                        <div class="d-flex">
                                                            <div class="feature-icon me-3 text-primary">
                                                                <i class="fas fa-book"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 fw-bold">Explain Concepts</h6>
                                                                <p class="text-muted small mb-0">Break down complex ideas into simple explanations</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="feature-item mb-3">
                                                        <div class="d-flex">
                                                            <div class="feature-icon me-3 text-primary">
                                                                <i class="fas fa-list-alt"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 fw-bold">Summarize</h6>
                                                                <p class="text-muted small mb-0">Get concise chapter summaries and key points</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="feature-item mb-3">
                                                        <div class="d-flex">
                                                            <div class="feature-icon me-3 text-primary">
                                                                <i class="fas fa-question-circle"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 fw-bold">Answer Questions</h6>
                                                                <p class="text-muted small mb-0">Get specific answers with page references</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="feature-item mb-3">
                                                        <div class="d-flex">
                                                            <div class="feature-icon me-3 text-primary">
                                                                <i class="fas fa-lightbulb"></i>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-1 fw-bold">Learning Guidance</h6>
                                                                <p class="text-muted small mb-0">Get personalized learning paths</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select a specific chapter for targeted questions, or use "All Chapters" for general inquiries.
                                </small>
                            </p>                            </div>
                        </div>
                    
                    <!-- Question Input Area with modern design -->
                    <div class="question-input-wrapper bg-white p-4 border-top" id="ask">
                        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); border-radius: 15px;">
                            <div class="card-body p-4">
                                <div class="row align-items-end">
                                    <div class="col">
                                        <div class="d-flex justify-content-between mb-3">
                                            <label for="question-input" class="form-label text-white fw-bold mb-0">
                                                <i class="fas fa-comment-dots me-2"></i>Ask your question about the book
                                            </label>
                                            <div id="input-status" class="d-none">
                                                <span class="small text-white">
                                                    <i class="fas fa-spinner fa-spin me-1"></i> AI is thinking...
                                                </span>
                                            </div>
                                        </div>
                                        <div class="input-group input-group-lg">
                                            <textarea id="question-input" class="form-control border-0" 
                                                placeholder="Type your question here... (e.g., 'Explain the key concepts', 'Summarize this chapter')" 
                                                rows="2" style="resize: none; border-radius: 15px 0 0 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></textarea>
                                            <button class="btn btn-light px-4 fw-bold" onclick="askQuestion()" 
                                                    style="border-radius: 0 15px 15px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                                <i class="fas fa-paper-plane me-2"></i> Ask AI
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="text-white-50">
                                            <i class="fas fa-lightbulb me-2"></i> 
                                            <span class="fw-medium">Tip:</span> Select a specific chapter from the sidebar for more focused answers
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="question-suggestions">
                                            <div class="d-flex justify-content-md-end align-items-center">
                                                <span class="text-white-50 me-2">Try asking about:</span>
                                                <div class="suggestion-chips">
                                                    <button class="btn btn-sm btn-light rounded-pill me-2 mb-2 mb-md-0" onclick="insertSuggestion('Summarize this chapter')">
                                                        <i class="fas fa-list-alt me-1"></i> Summary
                                                    </button>
                                                    <button class="btn btn-sm btn-light rounded-pill me-2 mb-2 mb-md-0" onclick="insertSuggestion('What are the key concepts?')">
                                                        <i class="fas fa-key me-1"></i> Key Points
                                                    </button>
                                                    <button class="btn btn-sm btn-light rounded-pill mb-2 mb-md-0" onclick="insertSuggestion('Explain with examples')">
                                                        <i class="fas fa-lightbulb me-1"></i> Examples
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Settings Modal -->
<div class="modal fade" id="apiSettingsModal" tabindex="-1" aria-labelledby="apiSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="apiSettingsModalLabel">AI Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="api-settings-form">
                    <div class="mb-3">
                        <label for="groq-api-key" class="form-label">Groq API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="groq-api-key" name="groq_api_key" 
                                placeholder="Enter your Groq API key" value="{{ book.groq_api_key }}">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Get a free API key from <a href="https://console.groq.com/" target="_blank">console.groq.com</a></small>
                    </div>
                    <div class="mb-3">
                        <label for="model-select" class="form-label">AI Model</label>
                        <select class="form-select" id="model-select" name="model_name">
                            <option value="llama-3.3-70b-versatile" {% if book.preferred_model == "llama-3.3-70b-versatile" %}selected{% endif %}>Llama 3.3 70B (Best Quality)</option>
                            <option value="llama-3.1-8b-instant" {% if book.preferred_model == "llama-3.1-8b-instant" %}selected{% endif %}>Llama 3.1 8B (Faster)</option>
                            <option value="gemma2-9b-it" {% if book.preferred_model == "gemma2-9b-it" %}selected{% endif %}>Gemma 2 9B</option>
                            <option value="mixtral-8x7b-32768" {% if book.preferred_model == "mixtral-8x7b-32768" %}selected{% endif %}>Mixtral 8x7B</option>
                            <option value="mistral-saba-24b" {% if book.preferred_model == "mistral-saba-24b" %}selected{% endif %}>Mistral Saba 24B</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-api-settings">Save Settings</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
let currentChapterId = '';
let currentChapterTitle = 'All Chapters';
let questionCount = 0;

function selectChapter(event, chapterId, chapterTitle) {
    // Prevent the default behavior and stop event propagation
    event.preventDefault();
    event.stopPropagation();
    
    // Deactivate all items first
    $('.toc-item').removeClass('active');
    
    // Find and activate the clicked item
    const $clickedItem = $(event.currentTarget);
    $clickedItem.addClass('active');
    
    // Get chapter data from the clicked item
    const level = $clickedItem.data('level');
    const startPage = $clickedItem.data('start-page');
    const endPage = $clickedItem.data('end-page');
    
    // Visual feedback animation
    $clickedItem.addClass('highlight-pulse');
    setTimeout(() => $clickedItem.removeClass('highlight-pulse'), 500);
    
    // Update UI elements
    $('#current-chapter').text(chapterTitle || 'All Chapters');
    
    // Determine badge properties
    let badgeText = 'General';
    let badgeClass = 'bg-primary';
    
    if (chapterId) {
        if (level > 1) {
            badgeText = `Section ${level}`;
            badgeClass = 'bg-info';
        } else {
            badgeText = 'Chapter';
            badgeClass = 'bg-success';
        }
        
        if (startPage && endPage) {
            badgeText += ` (p${startPage}-${endPage})`;
        }
    }
    
    // Update chapter badge
    $('#chapter-badge')
        .removeClass()
        .addClass(`badge ${badgeClass}`)
        .text(badgeText);
    
    // Store current chapter
    currentChapterId = chapterId;
    
    // Update chat interface
    updateChatInterface(chapterTitle);
    
    // Load frequent questions for this chapter
    try {
        loadFrequentQuestions(chapterId);
    } catch (error) {
        console.error('Error loading frequent questions:', error);
        $('#frequent-questions').html(
            `<div class="text-muted small">
                <i class="fas fa-exclamation-circle"></i>
                Unable to load questions. Please try again.
            </div>`
        );
    }
}

function updateChatInterface(chapterTitle) {
    const template = `
        <div class="text-center text-muted mt-5">
            <div class="mb-4">
                <i class="fas fa-book-open fa-4x text-primary mb-3" style="opacity: 0.7;"></i>
                <h4 class="text-primary">
                    <span class="highlight-text">${chapterTitle}</span>
                </h4>
                <p class="lead">Ready to explore this section!</p>
            </div>
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card border-0 bg-white shadow-sm">
                        <div class="card-body p-3">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-lightbulb me-1"></i>Available Features:
                            </h6>
                            <ul class="list-unstyled mb-0 text-start">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Content analysis
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Page references
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Smart explanations
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2"></i>Related topics
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#chat-messages').html(template);
    
    // Reset question count
    questionCount = 0;
    updateQuestionCounter();
}
}

function askQuestion() {
    const question = $('#question-input').val().trim();
    if (!question) {
        // Show a subtle animation to indicate empty input
        $('#question-input').addClass('is-invalid');
        setTimeout(() => $('#question-input').removeClass('is-invalid'), 1000);
        return;
    }
    
    // Hide welcome message if it exists
    $('#welcome-message').fadeOut(300, function() {
        $(this).remove();
    });
    
    // Add user message with improved styling
    addMessage(question, 'user');
    $('#question-input').val('').css('height', 'auto');
    
    // Show input status
    $('#input-status').removeClass('d-none');
    
    // Add typing indicator with animation
    const typingIndicator = $('<div class="typing-indicator mx-4 my-3" id="typing-indicator"><span></span><span></span><span></span></div>');
    $('#chat-messages').append(typingIndicator);
    
    // Scroll to bottom smoothly
    scrollToBottom();
    
    // Disable input and change button while processing
    $('#question-input').prop('disabled', true);
    const submitBtn = $('button[onclick="askQuestion()"]');
    const originalBtnHtml = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...').prop('disabled', true);
    
    // Update question counter
    questionCount++;
    updateQuestionCounter();
    
    // Track request start time for minimum display time
    const requestStartTime = Date.now();
    const minDisplayTime = 1200; // Minimum time to show typing indicator in ms
    
    // Send request with improved error handling
    $.ajax({
        url: '{% url "ask_question" book.id %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            question: question,
            chapter_id: currentChapterId
        }),
        success: function(response) {
            // Calculate how long to show the typing indicator
            const elapsedTime = Date.now() - requestStartTime;
            const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
            
            // Show typing indicator for at least minDisplayTime
            setTimeout(function() {
                // Remove typing indicator
                $('#typing-indicator').remove();
                $('#input-status').addClass('d-none');
                
                // Reset input and button
                $('#question-input').prop('disabled', false).focus();
                submitBtn.html(originalBtnHtml).prop('disabled', false);
                
                if (response.status === 'success') {
                    // Add AI response with improved styling
                    addMessage(response.response, 'assistant', response.sources);
                    
                    // Store question in recent questions
                    storeRecentQuestion(question, currentChapterId);
                    
                    // Reload frequent questions if in a chapter
                    if (currentChapterId) {
                        loadFrequentQuestions(currentChapterId);
                    }
                } else {
                    // Show error message with better styling
                    const errorMsg = `<div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        Error: ${response.message || 'Unknown error occurred'}
                                      </div>`;
                    addMessage(errorMsg, 'assistant');
                }
            }, remainingTime);
        },
        error: function(xhr) {
            // Remove typing indicator after delay
            setTimeout(function() {
                $('#typing-indicator').remove();
                $('#input-status').addClass('d-none');
                $('#question-input').prop('disabled', false).focus();
                submitBtn.html(originalBtnHtml).prop('disabled', false);
                
                let errorMessage = 'Sorry, something went wrong. Please check your API settings and try again.';
                
                // Try to get more specific error
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                
                const errorMsg = `<div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    ${errorMessage}
                                  </div>`;
                addMessage(errorMsg, 'assistant');
            }, 1000);
        }
    });
}

function clearChat() {
    // Modern confirmation modal instead of browser alert
    const confirmModal = `
        <div class="modal fade" id="clearChatModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Clear Conversation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-trash text-danger fa-3x mb-3"></i>
                            <h5>Are you sure you want to clear the chat history?</h5>
                            <p class="text-muted">This action cannot be undone.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmClearChat">
                            <i class="fas fa-trash me-2"></i>Clear Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $(confirmModal).appendTo('body');
    const modalEl = $('#clearChatModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    
    $('#confirmClearChat').click(function() {
        modal.hide();
        
        // Show loading spinner
        const loadingHtml = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h5>Clearing conversation...</h5>
            </div>
        `;
        $('#chat-messages').html(loadingHtml);
        
        $.get('{% url "clear_chat" book.id %}', function() {
            // Clear session storage
            if (window.sessionStorage) {
                sessionStorage.removeItem(`book_{{ book.id }}_messages`);
            }
            
            // Show welcome screen again with animation
            const welcomeHtml = `
                <div class="text-center py-5 welcome-animation" id="welcome-message">
                    <div class="ai-avatar mb-3">
                        <i class="fas fa-robot fa-4x text-primary"></i>
                        <div class="pulse-ring"></div>
                    </div>
                    <h3 class="text-primary fw-bold mb-2">Chat Cleared!</h3>
                    <p class="lead">Ready for a fresh start with "{{ book.title }}"</p>
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="insertSuggestion('Summarize this book')">
                            <i class="fas fa-book-open me-2"></i>Get a Summary
                        </button>
                    </div>
                </div>
            `;
            
            $('#chat-messages').html(welcomeHtml);
            
            // Reset question counter
            questionCount = 0;
            updateQuestionCounter();
        });
        
        modalEl.on('hidden.bs.modal', function() {
            modalEl.remove();
        });
    });
}

// Function to store recent questions for suggestions
function storeRecentQuestion(question, chapterId) {
    if (window.localStorage) {
        const bookId = '{{ book.id }}';
        let recentQuestions = JSON.parse(localStorage.getItem(`book_${bookId}_recent_questions`) || '[]');
        
        // Add new question
        recentQuestions.unshift({
            question: question,
            chapterId: chapterId || '',
            timestamp: new Date().toISOString()
        });
        
        // Keep only last 10 questions
        recentQuestions = recentQuestions.slice(0, 10);
        localStorage.setItem(`book_${bookId}_recent_questions`, JSON.stringify(recentQuestions));
    }
}

// Function to load recent questions
function showRecentQuestions() {
    if (window.localStorage) {
        const bookId = '{{ book.id }}';
        let recentQuestions = JSON.parse(localStorage.getItem(`book_${bookId}_recent_questions`) || '[]');
        
        if (recentQuestions.length > 0) {
            const modal = `
                <div class="modal fade" id="recentQuestionsModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Recent Questions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${recentQuestions.map(q => `
                                        <button class="list-group-item list-group-item-action recent-question" data-question="${q.question.replace(/"/g, '&quot;')}">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">${q.question}</h6>
                                                <small>${timeAgo(new Date(q.timestamp))}</small>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $(modal).appendTo('body');
            const modalEl = $('#recentQuestionsModal');
            const modalObj = new bootstrap.Modal(modalEl);
            modalObj.show();
            
            $('.recent-question').click(function() {
                const question = $(this).data('question');
                $('#question-input').val(question);
                modalObj.hide();
            });
            
            modalEl.on('hidden.bs.modal', function() {
                modalEl.remove();
            });
        }
    }
}

// Helper function for time formatting
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    
    if (seconds < 10) return "just now";
    
    return Math.floor(seconds) + " seconds ago";
}

// Helper functions
function rateResponse(type) {
    // You can implement feedback collection here
    console.log(`Response rated as: ${type}`);
}

function copyToClipboard(button) {
    const response = $(button).closest('.assistant-bubble').find('div[style*="white-space"]').text();
    navigator.clipboard.writeText(response).then(() => {
        $(button).html('<i class="fas fa-check text-success"></i>');
        setTimeout(() => {
            $(button).html('<i class="fas fa-copy"></i>');
        }, 2000);
    });
}

// Save API Settings
function saveAPISettings() {
    const apiKey = $('#groq-api-key').val().trim();
    const modelName = $('#model-select').val();
    
    $.ajax({
        url: '{% url "update_api_settings" %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            groq_api_key: apiKey,
            model_name: modelName,
            book_id: {{ book.id }}
        }),
        success: function(response) {
            if (response.status === 'success') {
                // Close modal and show success message
                $('#apiSettingsModal').modal('hide');
                alert('API settings saved successfully!');
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('An error occurred while saving settings.');
        }
    });
}

// Toggle password visibility
function togglePasswordVisibility() {
    const passwordInput = $('#groq-api-key');
    const icon = $('.toggle-password i');
    
    if (passwordInput.attr('type') === 'password') {
        passwordInput.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        passwordInput.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

// Setup event handlers
$(document).ready(function() {
    // Auto-resize textarea
    $('#question-input').on('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Enhanced keyboard shortcuts
    $('#question-input').keydown(function(e) {
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            askQuestion();
        } else if (e.which == 13 && e.shiftKey) {
            // Allow Shift+Enter for new line
            return true;
        }
    });
    
    // Add placeholder animations
    let placeholders = [
        "Ask me anything about this book...",
        "What would you like to learn?",
        "Type your question here...",
        "How can I help you understand this chapter?",
        "Ask for summaries, explanations, or examples..."
    ];
    let placeholderIndex = 0;
    
    setInterval(() => {
        if (!$('#question-input').is(':focus') && $('#question-input').val() === '') {
            $('#question-input').attr('placeholder', placeholders[placeholderIndex]);
            placeholderIndex = (placeholderIndex + 1) % placeholders.length;
        }
    }, 3000);
    
    // API Settings event handlers
    $('.toggle-password').click(togglePasswordVisibility);
    $('#save-api-settings').click(saveAPISettings);
    
    // Add some welcome interactivity
    setTimeout(() => {
        if ($('#welcome-message').length > 0) {
            $('#welcome-message').fadeIn('slow');
        }
    }, 500);
    
    // Add focus styling for better UX
    $('#question-input').focus(function() {
        $(this).parent().parent().addClass('shadow-lg');
    }).blur(function() {
        $(this).parent().parent().removeClass('shadow-lg');
    });
});

// Add TOC-specific CSS styles
$('<style>')
    .prop('type', 'text/css')
    .html(`
        .toc-item {
            transition: all 0.2s ease-in-out;
        }
        
        .toc-item:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .toc-item.active {
            background-color: rgba(13, 110, 253, 0.1);
            border-left: 3px solid #0d6efd;
        }
        
        .highlight-pulse {
            animation: pulse 0.5s;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .toc-toggle {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            width: 16px;
            display: inline-block;
            text-align: center;
        }
        
        .toc-children {
            transition: all 0.3s ease-in-out;
        }
        
        .toc-title {
            color: #333;
            font-weight: 500;
        }
        
        .toc-child .toc-title {
            font-weight: normal;
        }
        
        .no-results {
            color: #6c757d;
            font-style: italic;
        }
        
        .highlight-text {
            background: linear-gradient(120deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.1) 100%);
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }
    `)
    .appendTo('head');

// Enhanced TOC Functions
function toggleTOCSection(event, toggleIcon) {
    event.preventDefault();
    event.stopPropagation();
    
    const $icon = $(toggleIcon);
    const $chapter = $icon.closest('.toc-chapter');
    const $children = $chapter.find('.toc-children');
    
    if ($children.hasClass('show')) {
        $children.removeClass('show');
        $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
    } else {
        $children.addClass('show');
        $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
    }
}

function expandAllTOC() {
    $('.toc-children').addClass('show');
    $('.toc-toggle').removeClass('fa-chevron-right').addClass('fa-chevron-down');
}

function collapseAllTOC() {
    $('.toc-children').removeClass('show');
    $('.toc-toggle').removeClass('fa-chevron-down').addClass('fa-chevron-right');
}

function showTOCStats() {
    $('#tocStats').collapse('toggle');
}

function filterTOC() {
    const searchTerm = $('#toc-search').val().toLowerCase();
    const $tocItems = $('.toc-item');
    const $tocChapterGroups = $('.toc-chapter-group');
    
    if (!searchTerm) {
        $tocItems.show();
        $tocChapterGroups.show();
        $('.toc-children').removeClass('show');
        $('.toc-toggle').removeClass('fa-chevron-down').addClass('fa-chevron-right');
        return;
    }
    
    let hasVisibleItems = false;
    
    $tocItems.each(function() {
        const $item = $(this);
        const title = $item.find('.toc-title').text().trim().toLowerCase();
        const isMatch = title.includes(searchTerm);
        
        if (isMatch) {
            $item.show();
            hasVisibleItems = true;
            
            // Show parent containers
            const $chapterGroup = $item.closest('.toc-chapter-group');
            $chapterGroup.show();
            
            // If it's a child item, show its container and expand parent
            if ($item.hasClass('toc-child')) {
                const $tocChildren = $item.closest('.toc-children');
                $tocChildren.addClass('show');
                const $toggle = $chapterGroup.find('.toc-toggle').first();
                $toggle.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            }
        } else {
            $item.hide();
        }
    });
    
    // Handle empty state
    if (!hasVisibleItems) {
        $('#toc-list').append(
            `<div class="no-results p-3 text-center text-muted">
                <i class="fas fa-search me-2"></i>No matching chapters found
            </div>`
        );
    } else {
        $('.no-results').remove();
    }
    
    // Hide empty chapter groups
    $tocChapterGroups.each(function() {
        const $group = $(this);
        const hasVisibleChildren = $group.find('.toc-item:visible').length > 0;
        $group.toggle(hasVisibleChildren);
    });
}

function clearTOCSearch() {
    $('#toc-search').val('');
    filterTOC();
}

// Enhanced chapter selection with TOC integration
function selectChapter(event, chapterId, chapterTitle) {
    // Prevent the default behavior and stop event propagation
    event.preventDefault();
    event.stopPropagation();
    
    // Deactivate all items first
    $('.toc-item').removeClass('active');
    
    // Find and activate the clicked item
    const $clickedItem = $(event.currentTarget);
    $clickedItem.addClass('active');
    
    // Get chapter data from the clicked item
    const level = $clickedItem.data('level');
    const startPage = $clickedItem.data('start-page');
    const endPage = $clickedItem.data('end-page');
    
    // Visual feedback animation
    $clickedItem.addClass('highlight-pulse');
    setTimeout(() => $clickedItem.removeClass('highlight-pulse'), 500);
    
    // Update UI elements
    $('#current-chapter').text(chapterTitle || 'All Chapters');
    
    // Determine badge properties
    let badgeText = 'General';
    let badgeClass = 'bg-primary';
    
    if (chapterId) {
        if (level > 1) {
            badgeText = `Section ${level}`;
            badgeClass = 'bg-info';
        } else {
            badgeText = 'Chapter';
            badgeClass = 'bg-success';
        }
        
        if (startPage && endPage) {
            badgeText += ` (p${startPage}-${endPage})`;
        }
    }
    
    // Update chapter badge
    $('#chapter-badge')
        .removeClass()
        .addClass(`badge ${badgeClass}`)
        .text(badgeText);
    
    // Store current chapter
    currentChapterId = chapterId;
    
    // Update chat interface
    updateChatInterface(chapterTitle);
    
    // Load frequent questions for this chapter
    try {
        loadFrequentQuestions(chapterId);
    } catch (error) {
        console.error('Error loading frequent questions:', error);
        $('#frequent-questions').html(
            `<div class="text-muted small">
                <i class="fas fa-exclamation-circle"></i>
                Unable to load questions. Please try again.
            </div>`
        );
    }
}

function updateChatInterface(chapterTitle) {
    const template = `
        <div class="text-center text-muted mt-5">
            <div class="mb-4">
                <i class="fas fa-book-open fa-4x text-primary mb-3" style="opacity: 0.7;"></i>
                <h4 class="text-primary">
                    <span class="highlight-text">${chapterTitle}</span>
                </h4>
                <p class="lead">Ready to explore this section!</p>
            </div>
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card border-0 bg-white shadow-sm">
                        <div class="card-body p-3">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-lightbulb me-1"></i>Available Features:
                            </h6>
                            <ul class="list-unstyled mb-0 text-start">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Content analysis
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Page references
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>Smart explanations
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2"></i>Related topics
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#chat-messages').html(template);
    
    // Reset question count
    questionCount = 0;
    updateQuestionCounter();
}
}

function askQuestion() {
    const question = $('#question-input').val().trim();
    if (!question) {
        // Show a subtle animation to indicate empty input
        $('#question-input').addClass('is-invalid');
        setTimeout(() => $('#question-input').removeClass('is-invalid'), 1000);
        return;
    }
    
    // Hide welcome message if it exists
    $('#welcome-message').fadeOut(300, function() {
        $(this).remove();
    });
    
    // Add user message with improved styling
    addMessage(question, 'user');
    $('#question-input').val('').css('height', 'auto');
    
    // Show input status
    $('#input-status').removeClass('d-none');
    
    // Add typing indicator with animation
    const typingIndicator = $('<div class="typing-indicator mx-4 my-3" id="typing-indicator"><span></span><span></span><span></span></div>');
    $('#chat-messages').append(typingIndicator);
    
    // Scroll to bottom smoothly
    scrollToBottom();
    
    // Disable input and change button while processing
    $('#question-input').prop('disabled', true);
    const submitBtn = $('button[onclick="askQuestion()"]');
    const originalBtnHtml = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...').prop('disabled', true);
    
    // Update question counter
    questionCount++;
    updateQuestionCounter();
    
    // Track request start time for minimum display time
    const requestStartTime = Date.now();
    const minDisplayTime = 1200; // Minimum time to show typing indicator in ms
    
    // Send request with improved error handling
    $.ajax({
        url: '{% url "ask_question" book.id %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            question: question,
            chapter_id: currentChapterId
        }),
        success: function(response) {
            // Calculate how long to show the typing indicator
            const elapsedTime = Date.now() - requestStartTime;
            const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
            
            // Show typing indicator for at least minDisplayTime
            setTimeout(function() {
                // Remove typing indicator
                $('#typing-indicator').remove();
                $('#input-status').addClass('d-none');
                
                // Reset input and button
                $('#question-input').prop('disabled', false).focus();
                submitBtn.html(originalBtnHtml).prop('disabled', false);
                
                if (response.status === 'success') {
                    // Add AI response with improved styling
                    addMessage(response.response, 'assistant', response.sources);
                    
                    // Store question in recent questions
                    storeRecentQuestion(question, currentChapterId);
                    
                    // Reload frequent questions if in a chapter
                    if (currentChapterId) {
                        loadFrequentQuestions(currentChapterId);
                    }
                } else {
                    // Show error message with better styling
                    const errorMsg = `<div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        Error: ${response.message || 'Unknown error occurred'}
                                      </div>`;
                    addMessage(errorMsg, 'assistant');
                }
            }, remainingTime);
        },
        error: function(xhr) {
            // Remove typing indicator after delay
            setTimeout(function() {
                $('#typing-indicator').remove();
                $('#input-status').addClass('d-none');
                $('#question-input').prop('disabled', false).focus();
                submitBtn.html(originalBtnHtml).prop('disabled', false);
                
                let errorMessage = 'Sorry, something went wrong. Please check your API settings and try again.';
                
                // Try to get more specific error
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                
                const errorMsg = `<div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    ${errorMessage}
                                  </div>`;
                addMessage(errorMsg, 'assistant');
            }, 1000);
        }
    });
}

function clearChat() {
    // Modern confirmation modal instead of browser alert
    const confirmModal = `
        <div class="modal fade" id="clearChatModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Clear Conversation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-trash text-danger fa-3x mb-3"></i>
                            <h5>Are you sure you want to clear the chat history?</h5>
                            <p class="text-muted">This action cannot be undone.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmClearChat">
                            <i class="fas fa-trash me-2"></i>Clear Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $(confirmModal).appendTo('body');
    const modalEl = $('#clearChatModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    
    $('#confirmClearChat').click(function() {
        modal.hide();
        
        // Show loading spinner
        const loadingHtml = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h5>Clearing conversation...</h5>
            </div>
        `;
        $('#chat-messages').html(loadingHtml);
        
        $.get('{% url "clear_chat" book.id %}', function() {
            // Clear session storage
            if (window.sessionStorage) {
                sessionStorage.removeItem(`book_{{ book.id }}_messages`);
            }
            
            // Show welcome screen again with animation
            const welcomeHtml = `
                <div class="text-center py-5 welcome-animation" id="welcome-message">
                    <div class="ai-avatar mb-3">
                        <i class="fas fa-robot fa-4x text-primary"></i>
                        <div class="pulse-ring"></div>
                    </div>
                    <h3 class="text-primary fw-bold mb-2">Chat Cleared!</h3>
                    <p class="lead">Ready for a fresh start with "{{ book.title }}"</p>
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="insertSuggestion('Summarize this book')">
                            <i class="fas fa-book-open me-2"></i>Get a Summary
                        </button>
                    </div>
                </div>
            `;
            
            $('#chat-messages').html(welcomeHtml);
            
            // Reset question counter
            questionCount = 0;
            updateQuestionCounter();
        });
        
        modalEl.on('hidden.bs.modal', function() {
            modalEl.remove();
        });
    });
}

// Function to store recent questions for suggestions
function storeRecentQuestion(question, chapterId) {
    if (window.localStorage) {
        const bookId = '{{ book.id }}';
        let recentQuestions = JSON.parse(localStorage.getItem(`book_${bookId}_recent_questions`) || '[]');
        
        // Add new question
        recentQuestions.unshift({
            question: question,
            chapterId: chapterId || '',
            timestamp: new Date().toISOString()
        });
        
        // Keep only last 10 questions
        recentQuestions = recentQuestions.slice(0, 10);
        localStorage.setItem(`book_${bookId}_recent_questions`, JSON.stringify(recentQuestions));
    }
}

// Function to load recent questions
function showRecentQuestions() {
    if (window.localStorage) {
        const bookId = '{{ book.id }}';
        let recentQuestions = JSON.parse(localStorage.getItem(`book_${bookId}_recent_questions`) || '[]');
        
        if (recentQuestions.length > 0) {
            const modal = `
                <div class="modal fade" id="recentQuestionsModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Recent Questions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${recentQuestions.map(q => `
                                        <button class="list-group-item list-group-item-action recent-question" data-question="${q.question.replace(/"/g, '&quot;')}">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">${q.question}</h6>
                                                <small>${timeAgo(new Date(q.timestamp))}</small>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $(modal).appendTo('body');
            const modalEl = $('#recentQuestionsModal');
            const modalObj = new bootstrap.Modal(modalEl);
            modalObj.show();
            
            $('.recent-question').click(function() {
                const question = $(this).data('question');
                $('#question-input').val(question);
                modalObj.hide();
            });
            
            modalEl.on('hidden.bs.modal', function() {
                modalEl.remove();
            });
        }
    }
}

// Helper function for time formatting
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    
    if (seconds < 10) return "just now";
    
    return Math.floor(seconds) + " seconds ago";
}

// Helper functions
function rateResponse(type) {
    // You can implement feedback collection here
    console.log(`Response rated as: ${type}`);
}

function copyToClipboard(button) {
    const response = $(button).closest('.assistant-bubble').find('div[style*="white-space"]').text();
    navigator.clipboard.writeText(response).then(() => {
        $(button).html('<i class="fas fa-check text-success"></i>');
        setTimeout(() => {
            $(button).html('<i class="fas fa-copy"></i>');
        }, 2000);
    });
}

// Save API Settings
function saveAPISettings() {
    const apiKey = $('#groq-api-key').val().trim();
    const modelName = $('#model-select').val();
    
    $.ajax({
        url: '{% url "update_api_settings" %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            groq_api_key: apiKey,
            model_name: modelName,
            book_id: {{ book.id }}
        }),
        success: function(response) {
            if (response.status === 'success') {
                // Close modal and show success message
                $('#apiSettingsModal').modal('hide');
                alert('API settings saved successfully!');
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('An error occurred while saving settings.');
        }
    });
}

// Toggle password visibility
function togglePasswordVisibility() {
    const passwordInput = $('#groq-api-key');
    const icon = $('.toggle-password i');
    
    if (passwordInput.attr('type') === 'password') {
        passwordInput.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        passwordInput.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

// Setup event handlers
$(document).ready(function() {
    // Auto-resize textarea
    $('#question-input').on('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Enhanced keyboard shortcuts
    $('#question-input').keydown(function(e) {
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            askQuestion();
        } else if (e.which == 13 && e.shiftKey) {
            // Allow Shift+Enter for new line
            return true;
        }
    });
    
    // Add placeholder animations
    let placeholders = [
        "Ask me anything about this book...",
        "What would you like to learn?",
        "Type your question here...",
        "How can I help you understand this chapter?",
        "Ask for summaries, explanations, or examples..."
    ];
    let placeholderIndex = 0;
    
    setInterval(() => {
        if (!$('#question-input').is(':focus') && $('#question-input').val() === '') {
            $('#question-input').attr('placeholder', placeholders[placeholderIndex]);
            placeholderIndex = (placeholderIndex + 1) % placeholders.length;
        }
    }, 3000);
    
    // API Settings event handlers
    $('.toggle-password').click(togglePasswordVisibility);
    $('#save-api-settings').click(saveAPISettings);
    
    // Add some welcome interactivity
    setTimeout(() => {
        if ($('#welcome-message').length > 0) {
            $('#welcome-message').fadeIn('slow');
        }
    }, 500);
    
    // Add focus styling for better UX
    $('#question-input').focus(function() {
        $(this).parent().parent().addClass('shadow-lg');
    }).blur(function() {
        $(this).parent().parent().removeClass('shadow-lg');
    });
});

// Add TOC-specific CSS styles
$('<style>')
    .prop('type', 'text/css')
    .html(`
        .toc-item {
            transition: all 0.2s ease-in-out;
        }
        
        .toc-item:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .toc-item.active {
            background-color: rgba(13, 110, 253, 0.1);
            border-left: 3px solid #0d6efd;
        }
        
        .highlight-pulse {
            animation: pulse 0.5s;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .toc-toggle {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            width: 16px;
            display: inline-block;
            text-align: center;
        }
        
        .toc-children {
            transition: all 0.3s ease-in-out;
        }
        
        .toc-title {
            color: #333;
            font-weight: 500;
        }
        
        .toc-child .toc-title {
            font-weight: normal;
        }
        
        .no-results {
            color: #6c757d;
            font-style: italic;
        }
        
        .highlight-text {
            background: linear-gradient(120deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.1) 100%);
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }
    `)
    .appendTo('head');

// Enhanced TOC Functions
function toggleTOCSection(event, toggleIcon) {
    event.preventDefault();
    event.stopPropagation();
    
    const $icon = $(toggleIcon);
    const $chapter = $icon.closest('.toc-chapter');
    const $children = $chapter.find('.toc-children');
    
    if ($children.hasClass('show')) {
        $children.removeClass('show');
        $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
    } else {
        $children.addClass('show');
        $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
    }
}

function expandAllTOC() {
    $('.toc-children').addClass('show');
    $('.toc-toggle').removeClass('fa-chevron-right').addClass('fa-chevron-down');
}

function collapseAllTOC() {
    $('.toc-children').removeClass('show');
    $('.toc-toggle').removeClass('fa-chevron-down').addClass('fa-chevron-right');
}

function showTOCStats() {
    $('#tocStats').collapse('toggle');
}

function filterTOC() {
    const searchTerm = $('#toc-search').val().toLowerCase();
    const $tocItems = $('.toc-item');
    const $tocChapterGroups = $('.toc-chapter-group');
    
    if (!searchTerm) {
        $tocItems.show();
        $tocChapterGroups.show();
        $('.toc-children').removeClass('show');
        $('.toc-toggle').removeClass('fa-chevron-down').addClass('fa-chevron-right');
        return;
    }
    
    let hasVisibleItems = false;
    
    $tocItems.each(function() {
        const $item = $(this);
        const title = $item.find('.toc-title').text().trim().toLowerCase();
        const isMatch = title.includes(searchTerm);
        
        if (isMatch) {
            $item.show();
            hasVisibleItems = true;
            
            // Show parent containers
            const $chapterGroup = $item.closest('.toc-chapter-group');
            $chapterGroup.show();
            
            // If it's a child item, show its container and expand parent
            if ($item.hasClass('toc-child')) {
                const $tocChildren = $item.closest('.toc-children');
                $tocChildren.addClass('show');
                const $toggle = $chapterGroup.find('.toc-toggle').first();
                $toggle.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            }
        } else {
            $item.hide();
        }
    });
    
    // Handle empty state
    if (!hasVisibleItems) {
        $('#toc-list').append(
            `<div class="no-results p-3 text-center text-muted">
                <i class="fas fa-search me-2"></i>No matching chapters found
            </div>`
        );
    } else {
        $('.no-results').remove();
    }
    
    // Hide empty chapter groups
    $tocChapterGroups.each(function() {
        const $group = $(this);
        const hasVisibleChildren = $group.find('.toc-item:visible').length > 0;
        $group.toggle(hasVisibleChildren);
    });
}

function clearTOCSearch() {
    $('#toc-search').val('');
    filterTOC();
}
{% endblock %}