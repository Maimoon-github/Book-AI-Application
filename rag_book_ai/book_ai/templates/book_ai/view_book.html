{% extends 'book_ai/base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ book.title }}</h5>
                    <p class="text-muted">{{ book.page_count }} pages</p>
                    
                    <!-- API Settings -->
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#apiSettingsModal">
                            <i class="fas fa-cogs"></i> AI Settings
                        </button>
                    </div>
                    
                    <h6 class="mt-4">Chapters</h6>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" 
                           data-chapter-id="" onclick="selectChapter(event, '', 'All Chapters')">
                            All Chapters
                        </a>
                        {% for chapter in chapters %}
                            <a href="#" class="list-group-item list-group-item-action" 
                               data-chapter-id="{{ chapter.id }}"
                               onclick="selectChapter(event, {{ chapter.id }}, '{{ chapter.title }}')">
                                {{ chapter.title }}
                                {% if chapter.children.exists %}
                                    <i class="fas fa-chevron-down float-end"></i>
                                {% endif %}
                            </a>
                            {% for child in chapter.children.all %}
                                <a href="#" class="list-group-item list-group-item-action ps-4"
                                   data-chapter-id="{{ child.id }}"
                                   onclick="selectChapter(event, {{ child.id }}, '{{ child.title }}')">
                                    {{ child.title }}
                                </a>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    
                    <!-- Frequent Questions -->
                    <div id="frequent-questions" class="mt-4">
                        <h6>Frequent Questions</h6>
                        <div id="questions-list">
                            <p class="text-muted">Select a chapter to see frequent questions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="current-chapter">All Chapters</h5>
                        <button class="btn btn-outline-danger" onclick="clearChat()">
                            <i class="fas fa-trash"></i> Clear Chat
                        </button>
                    </div>
                    
                    <!-- Chat Area -->
                    <div id="chat-messages" class="mb-3" style="height: 500px; overflow-y: auto;">
                        <!-- Messages will be added here -->
                    </div>
                    
                    <!-- Input Area -->
                    <div class="input-group">
                        <input type="text" id="question-input" class="form-control" 
                               placeholder="Ask a question about the book...">
                        <button class="btn btn-primary" onclick="askQuestion()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Settings Modal -->
<div class="modal fade" id="apiSettingsModal" tabindex="-1" aria-labelledby="apiSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="apiSettingsModalLabel">AI Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="api-settings-form">
                    <div class="mb-3">
                        <label for="groq-api-key" class="form-label">Groq API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="groq-api-key" name="groq_api_key" 
                                placeholder="Enter your Groq API key" value="{{ book.groq_api_key }}">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Get a free API key from <a href="https://console.groq.com/" target="_blank">console.groq.com</a></small>
                    </div>
                    <div class="mb-3">
                        <label for="model-select" class="form-label">AI Model</label>
                        <select class="form-select" id="model-select" name="model_name">
                            <option value="llama-3.3-70b-versatile" {% if book.preferred_model == "llama-3.3-70b-versatile" %}selected{% endif %}>Llama 3.3 70B (Best Quality)</option>
                            <option value="llama-3.1-8b-instant" {% if book.preferred_model == "llama-3.1-8b-instant" %}selected{% endif %}>Llama 3.1 8B (Faster)</option>
                            <option value="gemma2-9b-it" {% if book.preferred_model == "gemma2-9b-it" %}selected{% endif %}>Gemma 2 9B</option>
                            <option value="mixtral-8x7b-32768" {% if book.preferred_model == "mixtral-8x7b-32768" %}selected{% endif %}>Mixtral 8x7B</option>
                            <option value="mistral-saba-24b" {% if book.preferred_model == "mistral-saba-24b" %}selected{% endif %}>Mistral Saba 24B</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-api-settings">Save Settings</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
let currentChapterId = '';
let currentChapterTitle = 'All Chapters';

function selectChapter(event, chapterId, chapterTitle) {
    event.preventDefault();
    currentChapterId = chapterId;
    currentChapterTitle = chapterTitle;
    
    // Update UI
    $('#current-chapter').text(chapterTitle);
    $('.list-group-item').removeClass('active');
    $(event.target).addClass('active');
    
    // Load frequent questions
    if (chapterId) {
        loadFrequentQuestions(chapterId);
    } else {
        $('#questions-list').html('<p class="text-muted">Select a chapter to see frequent questions.</p>');
    }
}

function loadFrequentQuestions(chapterId) {
    $.get(`/chapter/${chapterId}/frequent-questions/`, function(response) {
        let html = '';
        if (response.questions.length > 0) {
            response.questions.forEach(q => {
                html += `
                    <div class="frequent-question p-2 mb-1 rounded" onclick="askFrequentQuestion('${q.text}')">
                        <small class="text-muted">${q.frequency}Ã—</small>
                        ${q.text}
                    </div>`;
            });
        } else {
            html = '<p class="text-muted">No questions asked about this chapter yet.</p>';
        }
        $('#questions-list').html(html);
    });
}

function askFrequentQuestion(question) {
    $('#question-input').val(question);
    askQuestion();
}

function addMessage(content, role, sources = null) {
    const messageDiv = $('<div>').addClass(`chat-message ${role}-message`);
    messageDiv.html(`<p>${content}</p>`);
    
    if (sources && sources.length > 0) {
        const sourcesList = $('<div>').addClass('sources-list mt-2');
        sourcesList.html('<strong>Sources:</strong><ul>' + 
            sources.map(s => `<li>${s}</li>`).join('') + '</ul>');
        messageDiv.append(sourcesList);
    }
    
    $('#chat-messages').append(messageDiv);
    $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
}

function askQuestion() {
    const question = $('#question-input').val().trim();
    if (!question) return;
    
    // Add user message
    addMessage(question, 'user');
    $('#question-input').val('');
    
    // Send request
    $.ajax({
        url: '{% url "ask_question" book.id %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            question: question,
            chapter_id: currentChapterId
        }),
        success: function(response) {
            if (response.status === 'success') {
                addMessage(response.response, 'assistant', response.sources);
                
                // Reload frequent questions if in a chapter
                if (currentChapterId) {
                    loadFrequentQuestions(currentChapterId);
                }
            } else {
                addMessage('Error: ' + response.message, 'assistant');
            }
        },
        error: function() {
            addMessage('Sorry, something went wrong. Please try again.', 'assistant');
        }
    });
}

function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        $.get('{% url "clear_chat" book.id %}', function() {
            $('#chat-messages').empty();
        });
    }
}

// Save API Settings
function saveAPISettings() {
    const apiKey = $('#groq-api-key').val().trim();
    const modelName = $('#model-select').val();
    
    $.ajax({
        url: '{% url "update_api_settings" %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            groq_api_key: apiKey,
            model_name: modelName,
            book_id: {{ book.id }}
        }),
        success: function(response) {
            if (response.status === 'success') {
                // Close modal and show success message
                $('#apiSettingsModal').modal('hide');
                alert('API settings saved successfully!');
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('An error occurred while saving settings.');
        }
    });
}

// Toggle password visibility
function togglePasswordVisibility() {
    const passwordInput = $('#groq-api-key');
    const icon = $('.toggle-password i');
    
    if (passwordInput.attr('type') === 'password') {
        passwordInput.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        passwordInput.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

// Setup event handlers
$(document).ready(function() {
    $('#question-input').keypress(function(e) {
        if (e.which == 13) {
            askQuestion();
        }
    });
    
    // API Settings event handlers
    $('.toggle-password').click(togglePasswordVisibility);
    $('#save-api-settings').click(saveAPISettings);
});
</script>
{% endblock %}
{% endblock %}
