{% extends 'book_ai/base.html' %}
{% load math_filters %}

{% block content %}
<div class="container mt-4">
    <!-- Hero section -->
    <div class="row align-items-center mb-5 py-4">
        <div class="col-lg-6">            <h1 class="display-4 fw-bold mb-3">Book AI <span style="color: black;">Assistant</span></h1>
            <p class="lead mb-4" style="color: black;">Transform your reading experience with AI-powered insights, summaries, and interactive learning from any book.</p>
            <div class="d-flex gap-3">
                <a href="#upload-section" class="btn btn-primary btn-lg px-4">
                    <i class="fas fa-upload me-2"></i>Upload a Book
                </a>
                <a href="#books-library" class="btn btn-outline-secondary btn-lg px-4">
                    <i class="fas fa-book me-2"></i>Browse Library
                </a>
            </div>
        </div>        <div class="col-lg-6 d-none d-lg-block">
            <div class="text-center">
                <img src="/media/profile_pics/Logo.png" alt="Book AI Illustration" class="img-fluid rounded shadow-lg" style="max-height: 300px;">
                <div class="mt-3">
                    <h4 style="color: black;">Your Personal Book Assistant</h4>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-5" id="upload-section">
        <div class="col-lg-6">
            <!-- API Key Settings -->
            <div class="card mb-4 border-0 shadow-sm">                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0" style="color: black;">
                        <i class="fas fa-cogs me-2" style="color: black;"></i>AI Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form id="api-settings-form">
                        <div class="mb-3">
                            <label for="groq-api-key" class="form-label fw-medium">Groq API Key</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="password" class="form-control" id="groq-api-key" name="groq_api_key" 
                                       placeholder="Enter your Groq API key" value="{{ groq_api_key }}">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-bs-toggle="tooltip" title="Show/Hide API Key">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small style="color: black;">Get a free API key from <a href="https://console.groq.com/" target="_blank" class="text-decoration-none" style="color: black;">console.groq.com</a></small>
                        </div>
                        <div class="mb-3">
                            <label for="model-select" class="form-label fw-medium">AI Model</label>
                            <select class="form-select" id="model-select" name="model_name">
                                <option value="llama-3.3-70b-versatile" {% if preferred_model == "llama-3.3-70b-versatile" %}selected{% endif %}>
                                    Llama 3.3 70B (Best Quality)
                                </option>
                                <option value="llama-3.1-8b-instant" {% if preferred_model == "llama-3.1-8b-instant" %}selected{% endif %}>
                                    Llama 3.1 8B (Faster)
                                </option>
                                <option value="gemma2-9b-it" {% if preferred_model == "gemma2-9b-it" %}selected{% endif %}>
                                    Gemma 2 9B
                                </option>
                                <option value="mixtral-8x7b-32768" {% if preferred_model == "mixtral-8x7b-32768" %}selected{% endif %}>
                                    Mixtral 8x7B
                                </option>
                                <option value="mistral-saba-24b" {% if preferred_model == "mistral-saba-24b" %}selected{% endif %}>
                                    Mistral Saba 24B
                                </option>
                            </select>
                            <div class="form-text" style="color: black;">Choose faster models for quicker responses or higher quality for complex questions.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <!-- Upload Form -->
            <div class="card mb-4 border-0 shadow-sm">                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0" style="color: black;">
                        <i class="fas fa-upload me-2" style="color: black;"></i>Upload a Book
                    </h5>
                </div>
                <div class="card-body">
                    <form id="upload-form" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}                        <div class="mb-4">
                            <label for="pdf-file" class="form-label fw-medium">Select PDF Book</label>
                            <div class="input-group mb-3">
                                <input type="file" class="form-control" name="pdf_file" id="pdf-file" accept=".pdf" required>
                                <label class="input-group-text" for="pdf-file"><i class="fas fa-file-pdf"></i></label>
                            </div>
                            <div class="form-text" style="color: black;">Maximum file size: 50MB. Supported format: PDF</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="custom-title" class="form-label fw-medium">Custom Book Title (Optional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-bookmark"></i></span>
                                <input type="text" class="form-control" name="custom_title" id="custom-title" 
                                       placeholder="Enter a custom title for your book">
                            </div>
                            <div class="form-text" style="color: black;">Leave blank to use the original book title from the PDF</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload and Process
                        </button>
                    </form>
                    
                    <div id="upload-progress" class="mt-4 d-none">
                        <p class="text-muted mb-2"><i class="fas fa-spinner fa-spin me-2"></i>Processing book, please wait...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">This may take a few minutes for large books.</small>
                    </div>
                </div>
            </div>
        </div>      <!-- Book Library Section -->
    <div id="books-library" class="mb-4">
        <!-- Modern Header with Glassmorphism -->
        <div class="library-header mb-4">
            <div class="d-flex justify-content-between align-items-center p-3 rounded-3" 
                 style="background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                <div>
                    <h2 class="fw-bold mb-1" style="color: #000000; font-size: 1.5rem;">
                        <i class="fas fa-book-open me-2 text-primary"></i>Your Book Library
                    </h2>
                    <small class="text-muted">Manage and explore your collection</small>
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    <!-- Compact Search -->
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control glass-input" id="book-search" 
                               placeholder="Search books..." aria-label="Search books"
                               style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.5);">
                        <button class="btn btn-outline-primary btn-sm" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- Sort Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort me-1"></i> Sort
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end glass-dropdown" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item" href="#" data-sort="newest"><i class="fas fa-calendar me-2 text-primary"></i>Newest First</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="oldest"><i class="fas fa-calendar-alt me-2 text-primary"></i>Oldest First</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="name"><i class="fas fa-sort-alpha-down me-2 text-primary"></i>Name</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="pages"><i class="fas fa-file-alt me-2 text-primary"></i>Page Count</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        {% if books %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 book-cards">
                {% for book in books %}
                    <div class="col">
                        <div class="modern-book-card glass-card" data-title="{{ book.title }}" data-date="{{ book.uploaded_at|date:'Y-m-d' }}" data-pages="{{ book.page_count }}">
                            <!-- Enhanced Card Header with File Info -->
                            <div class="card-header-modern">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="file-type-badge">
                                        <i class="fas fa-file-pdf me-1"></i>
                                        <span>PDF</span>
                                    </div>
                                    <div class="upload-date">
                                        <i class="far fa-calendar-alt me-1"></i>
                                        <span>{{ book.uploaded_at|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                                
                                <!-- File Location Info -->
                                <div class="file-location-info mb-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-folder-open me-2 text-primary" style="font-size: 0.8rem;"></i>
                                        <span class="file-path">{{ book.pdf_file.name|truncatechars:30 }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Body with Custom Title Support -->
                            <div class="card-body-modern">
                                <h5 class="book-title-modern">{{ book.title }}</h5>
                                
                                <!-- Book Stats -->
                                <div class="book-stats">
                                    <div class="stat-item">
                                        <i class="fas fa-file-alt text-primary"></i>
                                        <span>{{ book.page_count }} pages</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-clock text-success"></i>
                                        <span>~{{ book.page_count|intdiv:2 }} min</span>
                                    </div>
                                </div>
                                
                                <!-- Primary Action -->
                                <div class="primary-action mt-3">
                                    <a href="{% url 'view_book' book.id %}" class="btn btn-primary btn-modern w-100">
                                        <i class="fas fa-book-reader me-2"></i>Read & Study
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Enhanced Footer with Better Icons -->
                            <div class="card-footer-modern">
                                <div class="action-buttons">
                                    <button type="button" class="action-btn info-btn" data-bs-toggle="modal" data-bs-target="#bookInfoModal" 
                                            data-book-title="{{ book.title }}" data-book-pages="{{ book.page_count }}" 
                                            data-book-date="{{ book.uploaded_at|date:'F d, Y at H:i' }}" 
                                            data-book-path="{{ book.pdf_file.name }}" data-bs-toggle="tooltip" title="Book Information">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Info</span>
                                    </button>
                                    
                                    <button type="button" class="action-btn chat-btn" data-book-id="{{ book.id }}" 
                                            onclick="quickChat('{{ book.id }}', '{{ book.title }}')" data-bs-toggle="tooltip" title="Quick Chat">
                                        <i class="fas fa-comment-dots"></i>
                                        <span>Chat</span>
                                    </button>
                                    
                                    <button type="button" class="action-btn settings-btn" data-bs-toggle="modal" data-bs-target="#bookSettingsModal" 
                                            data-book-id="{{ book.id }}" data-book-title="{{ book.title }}" data-bs-toggle="tooltip" title="Book Settings">
                                        <i class="fas fa-cog"></i>
                                        <span>Settings</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Enhanced Empty State -->
            <div class="empty-library-state">
                <div class="text-center py-5">
                    <div class="empty-icon mb-4">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h4 class="empty-title">Your library awaits</h4>
                    <p class="empty-description">Upload your first book to begin your AI-powered learning journey</p>
                    <a href="#upload-section" class="btn btn-primary btn-modern mt-3">
                        <i class="fas fa-upload me-2"></i>Upload Your First Book
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Book Information Modal -->
<div class="modal fade" id="bookInfoModal" tabindex="-1" aria-labelledby="bookInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="bookInfoModalLabel" style="color: #000000;">
                    <i class="fas fa-info-circle text-primary me-2"></i>Book Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="info-section mb-4">
                            <h6 class="info-label">Title</h6>
                            <p class="info-value" id="modal-book-title">-</p>
                        </div>
                        
                        <div class="info-section mb-4">
                            <h6 class="info-label">File Location</h6>
                            <p class="info-value file-path-display" id="modal-book-path">-</p>
                        </div>
                        
                        <div class="info-section mb-4">
                            <h6 class="info-label">Upload Date</h6>
                            <p class="info-value" id="modal-book-date">-</p>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="info-stats">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-file-alt text-primary"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="modal-book-pages">-</div>
                                    <div class="stat-label">Pages</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Book Settings Modal -->
<div class="modal fade" id="bookSettingsModal" tabindex="-1" aria-labelledby="bookSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="bookSettingsModalLabel" style="color: #000000;">
                    <i class="fas fa-cog text-primary me-2"></i>Book Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="book-title-form">
                    <div class="mb-3">
                        <label for="custom-book-title" class="form-label fw-medium">Custom Book Title</label>
                        <input type="text" class="form-control glass-input" id="custom-book-title" 
                               placeholder="Enter custom title for this book">
                        <div class="form-text">Change how this book appears in your library</div>
                    </div>
                </form>
                
                <div class="settings-actions mt-4">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm view-book-btn">
                            <i class="fas fa-book-reader me-2"></i>Open Book
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash me-2"></i>Remove from Library
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveBookTitle()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Styles for Modern Library -->
<style>
/* Color Palette Variables - Based on Theme/Palette.svg */
:root {
    --primary-color: #e1732a;       /* Main orange */
    --secondary-color: #e68a4c;     /* Light orange */
    --tertiary-color: #eca474;      /* Lighter orange */
    --quaternary-color: #f1bf9d;    /* Pale orange */
    --quinary-color: #f7d9c5;       /* Very light orange */
    --senary-color: #fdf3ed;        /* Lightest orange */
      /* Text Colors */
    --text-dark: #000000;           /* Pure black for all text */
    --text-light: #000000;          /* Black for secondary text */
    --text-muted: #000000;          /* Black for muted text */
    
    /* Background Colors */
    --bg-gradient-start: #e1732a;
    --bg-gradient-end: #f7d9c5;
    
    /* UI Colors */
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.3);
    --shadow-light: rgba(0, 0, 0, 0.1);
    --shadow-medium: rgba(0, 0, 0, 0.15);
}

/* Glassmorphism Effects */
.glass-card {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    overflow: hidden;
}

.glass-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 0.35);
}

.glass-input {
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.glass-input:focus {
    background: rgba(255, 255, 255, 0.95) !important;
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 0.2rem rgba(225, 115, 42, 0.25) !important;
    transform: translateY(-1px);
}

/* Custom Title Input Enhancement */
#custom-title {
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    border-radius: 8px;
    transition: all 0.3s ease;
}

#custom-title:focus {
    background: rgba(255, 255, 255, 0.95) !important;
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 0.2rem rgba(225, 115, 42, 0.25) !important;
    transform: translateY(-1px);
}

/* Upload Form Enhancement */
.form-control, .form-select {
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(225, 115, 42, 0.25);
}

/* Animation for notifications */
.fade-in {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Ensure all text is black */
.text-dark, .text-muted, .text-light, 
h1, h2, h3, h4, h5, h6, p, span, div, 
.card-title, .card-text, .form-label, 
.dropdown-item, .btn, .modal-title, 
.modal-body, .list-group-item, .badge,
.toast-body, .alert, .form-text,
.info-label, .info-value, .stat-label,
.book-title-modern, .empty-title, .empty-description {
    color: #000000 !important;
}

/* Specific overrides for better contrast */
.btn-primary, .btn-success, .btn-danger, .btn-warning, .btn-info {
    color: #ffffff !important;
}

.text-white, .toast .text-white {
    color: #ffffff !important;
}

.glass-dropdown {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.glass-modal .modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.1);
}

/* Modern Book Cards */
.modern-book-card {
    height: 100%;
    position: relative;
    cursor: pointer;
}

.card-header-modern {
    padding: 1rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.file-type-badge {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
}

.upload-date {
    color: var(--text-light);
    font-size: 0.75rem;
    display: flex;
    align-items: center;
}

.file-location-info {
    background: rgba(225, 115, 42, 0.1);
    padding: 0.5rem;
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
}

.file-path {
    font-size: 0.8rem;
    color: var(--text-dark);
    font-family: 'Courier New', monospace;
    word-break: break-all;
}

.card-body-modern {
    padding: 1rem;
    flex-grow: 1;
}

.book-title-modern {
    color: var(--text-dark);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.book-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-light);
}

.btn-modern {
    border-radius: 12px;
    font-weight: 500;
    padding: 0.6rem 1rem;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
    position: relative;
    overflow: hidden;
}

.btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(225, 115, 42, 0.3);
}

.btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.btn-modern:hover::before {
    left: 100%;
}

.card-footer-modern {
    padding: 0.75rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.1) 100%);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: space-between;
}

.action-btn {
    flex: 1;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 0.5rem;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--text-dark);
    cursor: pointer;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.action-btn i {
    font-size: 1rem;
    transition: transform 0.3s ease;
}

.action-btn:hover i {
    transform: scale(1.1);
}

.info-btn:hover { border-color: #17a2b8; }
.info-btn:hover i { color: #17a2b8; }

.chat-btn:hover { border-color: #28a745; }
.chat-btn:hover i { color: #28a745; }

.settings-btn:hover { border-color: #6c757d; }
.settings-btn:hover i { color: #6c757d; }

/* Empty State */
.empty-library-state {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 2rem;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
}

.empty-icon i {
    font-size: 2rem;
    color: white;
}

.empty-title {
    color: var(--text-dark);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.empty-description {
    color: var(--text-light);
    margin-bottom: 0;
}

/* Modal Enhancements */
.info-section {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding-bottom: 0.75rem;
}

.info-label {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.info-value {
    color: var(--text-dark);
    margin-bottom: 0;
    font-size: 0.95rem;
}

.file-path-display {
    font-family: 'Courier New', monospace;
    background: rgba(225, 115, 42, 0.1);
    padding: 0.5rem;
    border-radius: 6px;
    word-break: break-all;
}

.stat-card {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.stat-icon i {
    font-size: 1.5rem;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.25rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .library-header .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        flex-direction: row;
        justify-content: center;
    }
    
    .book-stats {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show toast notifications instead of alerts
    function showToast(message, type) {
        const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
        const toast = `
            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                <div class="toast align-items-center ${toastClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        `;
        
        $(toast).appendTo('body');
        const toastEl = $('.toast').last();
        const toastObj = new bootstrap.Toast(toastEl, { delay: 3000 });
        toastObj.show();
        
        setTimeout(() => {
            toastEl.parent().remove();
        }, 3500);
    }

    // API Settings form submission with improved UX
    $('#api-settings-form').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalBtnText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...').prop('disabled', true);
        
        var apiKey = $('#groq-api-key').val().trim();
        var modelName = $('#model-select').val();
        
        $.ajax({
            url: '{% url "update_api_settings" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                groq_api_key: apiKey,
                model_name: modelName
            }),
            success: function(response) {                // Reset button
                submitBtn.html(originalBtnText).prop('disabled', false);
                
                if (response.status === 'success') {
                    showToast('API settings saved successfully!', 'success');
                } else {
                    showToast('Error: ' + response.message, 'error');
                }
            },
            error: function() {
                // Reset button
                submitBtn.html(originalBtnText).prop('disabled', false);
                showToast('An error occurred while saving settings.', 'error');
            }
        });
    });
    
    // Toggle password visibility for API key input
    $('.toggle-password').click(function() {
        const input = $(this).closest('.input-group').find('input');
        const icon = $(this).find('i');
        
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });    // File upload with custom title auto-population
    $('#pdf-file').on('change', function() {
        const file = this.files[0];
        const customTitleInput = $('#custom-title');
        
        if (file) {
            // Extract filename without extension as suggested title
            const fileName = file.name.replace(/\.[^/.]+$/, "");
            const suggestedTitle = fileName.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            // Only populate if the field is empty
            if (!customTitleInput.val().trim()) {
                customTitleInput.val(suggestedTitle);
                
                // Add a subtle highlight animation
                customTitleInput.addClass('bg-warning bg-opacity-25');
                setTimeout(() => {
                    customTitleInput.removeClass('bg-warning bg-opacity-25');
                }, 1500);
                
                // Show a subtle notification
                const notification = $(`
                    <small class="text-muted d-block mt-1 fade-in" id="title-suggestion">
                        <i class="fas fa-magic me-1 text-primary"></i>
                        Auto-filled from filename. You can edit this title.
                    </small>
                `);
                
                // Remove any existing notification
                $('#title-suggestion').remove();
                
                // Add new notification
                customTitleInput.parent().after(notification);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);
            }
        }
    });
    
    // File upload with progress simulation
    $('#upload-form').on('submit', function(e) {
        // Don't prevent default - we want the actual form submission to happen
        const progressBar = $('#upload-progress');
        progressBar.removeClass('d-none');
        
        // Show progress bar animation
        const bar = progressBar.find('.progress-bar');
        bar.css('width', '0%');
        
        // Simulate progress - in a real implementation this should use actual upload progress events
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.floor(Math.random() * 10) + 1;
            if (progress > 95) {
                progress = 95; // Let the actual completion finish it
                clearInterval(interval);
            }
            bar.css('width', progress + '%').attr('aria-valuenow', progress);
        }, 300);
    });
    
    // Book search functionality
    $('#book-search').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        
        $('.book-card').each(function() {
            const title = $(this).data('title').toLowerCase();
            if (title.includes(searchTerm)) {
                $(this).closest('.col').show();
            } else {
                $(this).closest('.col').hide();
            }
        });
    });
    
    // Book sorting functionality
    $('.dropdown-item[data-sort]').click(function(e) {
        e.preventDefault();
        const sortBy = $(this).data('sort');
        const container = $('.book-cards');
        const items = container.children('.col').get();
        
        items.sort(function(a, b) {
            const cardA = $(a).find('.book-card');
            const cardB = $(b).find('.book-card');
            
            switch(sortBy) {
                case 'newest':
                    return new Date($(cardB).data('date')) - new Date($(cardA).data('date'));
                case 'oldest':
                    return new Date($(cardA).data('date')) - new Date($(cardB).data('date'));
                case 'name':
                    return $(cardA).data('title').localeCompare($(cardB).data('title'));
                case 'pages':
                    return $(cardB).data('pages') - $(cardA).data('pages');
                default:
                    return 0;
            }
        });
        
        $.each(items, function(i, item) {
            container.append(item);
        });
    });
    
    // Book info button handler
    $('.book-info').click(function() {
        const card = $(this).closest('.book-card');
        const title = card.data('title');
        const pages = card.data('pages');
        const date = card.data('date');
        
        // Create and show modal with book info
        const modal = `
            <div class="modal fade" id="bookInfoModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Pages:</strong> ${pages}</p>
                            <p><strong>Upload Date:</strong> ${date}</p>
                            <p><strong>Estimated Reading Time:</strong> ${Math.round(pages/2)} minutes</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $(modal).appendTo('body');
        const modalEl = $('#bookInfoModal');
        const modalObj = new bootstrap.Modal(modalEl);
        modalObj.show();
        
        modalEl.on('hidden.bs.modal', function () {
            modalEl.remove();
        });
    });
    
    // Book settings button handler
    $('.book-settings').click(function() {
        const bookId = $(this).data('book-id');
        window.location.href = `{% url 'view_book' 0 %}`.replace('0', bookId) + '#settings';
    });
    
    // Quick question button handler
    $('.quick-question').click(function() {
        const bookId = $(this).data('book-id');
        window.location.href = `{% url 'view_book' 0 %}`.replace('0', bookId) + '#ask';
    });
    
    // Toggle password visibility
    $('.toggle-password').click(function() {
        var passwordInput = $('#groq-api-key');
        var icon = $(this).find('i');
        
        if (passwordInput.attr('type') === 'password') {
            passwordInput.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            passwordInput.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });

    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        
        var form = $(this);
        var formData = new FormData(form[0]);
        
        // Show progress bar
        $('#upload-progress').removeClass('d-none');
        
        $.ajax({
            url: '{% url "upload_book" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        $('.progress-bar').css('width', percentComplete * 100 + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.status === 'success') {
                    window.location.href = '/book/' + response.book_id + '/';
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Upload failed. Please try again.');
            },            complete: function() {
                $('#upload-progress').addClass('d-none');
                $('.progress-bar').css('width', '0%');
            }
        });
    });
    
    // Book info modal handler
    $('#bookInfoModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var title = button.data('book-title');
        var pages = button.data('book-pages');
        var date = button.data('book-date');
        var path = button.data('book-path');
        
        var modal = $(this);
        modal.find('#modal-book-title').text(title);
        modal.find('#modal-book-pages').text(pages);
        modal.find('#modal-book-date').text(date);
        modal.find('#modal-book-path').text(path);
    });

    // Book settings modal handler
    $('#bookSettingsModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var bookId = button.data('book-id');
        var title = button.data('book-title');
        
        var modal = $(this);
        modal.find('#custom-book-title').val(title);
        modal.find('.view-book-btn').attr('onclick', `viewBook(${bookId})`);
        
        // Store book ID for saving
        modal.data('current-book-id', bookId);
    });
});

// Quick chat function
function quickChat(bookId, bookTitle) {
    // Redirect to book view with chat focus
    window.location.href = `{% url 'view_book' 0 %}`.replace('0', bookId) + '#chat';
}

// View book function
function viewBook(bookId) {
    window.location.href = `{% url 'view_book' 0 %}`.replace('0', bookId);
}

// Save book title function
function saveBookTitle() {
    var modal = $('#bookSettingsModal');
    var bookId = modal.data('current-book-id');
    var newTitle = $('#custom-book-title').val().trim();
    
    if (!newTitle) {
        showToast('Please enter a valid title.', 'error');
        return;
    }
    
    // Here you would make an AJAX call to save the title
    // For now, we'll just update the UI and show a message
    showToast('Title will be updated on next page refresh.', 'success');
    modal.modal('hide');
}
</script>
{% endblock %}
{% endblock %}
