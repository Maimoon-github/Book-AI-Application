{% extends 'book_ai/base.html' %}
{% load math_filters %}

{% block content %}
<div class="container mt-4">    <!-- Hero section - more compact -->
    <div class="row align-items-center mb-4 py-3">
        <div class="col-lg-6">
            <h1 class="display-4 fw-bold mb-2">Book AI <span>Assistant</span></h1>
            <p class="lead mb-3">Transform your reading experience with AI-powered insights, summaries, and interactive learning from any book.</p>
            <div class="d-flex gap-2">
                <a href="#upload-section" class="btn btn-primary px-3">
                    <i class="fas fa-upload me-1"></i>Upload a Book
                </a>
                <a href="#books-library" class="btn btn-outline-secondary px-3">
                    <i class="fas fa-book me-1"></i>Browse Library
                </a>
            </div>
        </div>        <div class="col-lg-6 d-none d-lg-block">
            <div class="text-center">
                <img src="/media/profile_pics/Logo.png" alt="Book AI Illustration" class="img-fluid rounded shadow" style="max-height: 250px;">
                <div class="mt-2">
                    <h4>Your Personal Book Assistant</h4>
                </div>
            </div>
        </div>
    </div>
      <div class="row mb-4" id="upload-section">
        <div class="col-lg-6">
            <!-- API Key Settings -->
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-white py-2">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-1"></i>AI Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form id="api-settings-form">
                        <div class="mb-3">
                            <label for="groq-api-key" class="form-label fw-medium">Groq API Key</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="password" class="form-control" id="groq-api-key" name="groq_api_key" 
                                       placeholder="Enter your Groq API key" value="{{ groq_api_key }}">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-bs-toggle="tooltip" title="Show/Hide API Key">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small style="color: black;">Get a free API key from <a href="https://console.groq.com/" target="_blank" class="text-decoration-none" style="color: black;">console.groq.com</a></small>
                        </div>
                        <div class="mb-3">
                            <label for="model-select" class="form-label fw-medium">AI Model</label>
                            <select class="form-select" id="model-select" name="model_name">
                                <option value="llama-3.3-70b-versatile" {% if preferred_model == "llama-3.3-70b-versatile" %}selected{% endif %}>
                                    Llama 3.3 70B (Best Quality)
                                </option>
                                <option value="llama-3.1-8b-instant" {% if preferred_model == "llama-3.1-8b-instant" %}selected{% endif %}>
                                    Llama 3.1 8B (Faster)
                                </option>
                                <option value="gemma2-9b-it" {% if preferred_model == "gemma2-9b-it" %}selected{% endif %}>
                                    Gemma 2 9B
                                </option>
                                <option value="mixtral-8x7b-32768" {% if preferred_model == "mixtral-8x7b-32768" %}selected{% endif %}>
                                    Mixtral 8x7B
                                </option>
                                <option value="mistral-saba-24b" {% if preferred_model == "mistral-saba-24b" %}selected{% endif %}>
                                    Mistral Saba 24B
                                </option>
                            </select>
                            <div class="form-text" style="color: black;">Choose faster models for quicker responses or higher quality for complex questions.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <!-- Upload Form -->
            <div class="card mb-4 border-0 shadow-sm">                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0" style="color: black;">
                        <i class="fas fa-upload me-2" style="color: black;"></i>Upload a Book
                    </h5>
                </div>
                <div class="card-body">                    <form id="upload-form" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="pdf-file" class="form-label fw-medium">Select PDF Book</label>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" name="pdf_file" id="pdf-file" accept=".pdf" required>
                                <label class="input-group-text" for="pdf-file"><i class="fas fa-file-pdf"></i></label>
                            </div>
                            <div class="form-text" style="color: black;">Maximum file size: 50MB. Supported format: PDF</div>
                        </div>
                        <div class="mb-4">
                            <label for="book-name" class="form-label fw-medium">Book Name</label>
                            <input type="text" class="form-control" name="book_name" id="book-name" placeholder="Enter a custom name for this book" required>
                            <div class="form-text" style="color: black;">Give your book a memorable name to easily find it in your library</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload and Process
                        </button>
                    </form>
                    
                    <div id="upload-progress" class="mt-4 d-none">
                        <p class="text-muted mb-2"><i class="fas fa-spinner fa-spin me-2"></i>Processing book, please wait...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">This may take a few minutes for large books.</small>
                    </div>
                </div>
            </div>
        </div>    
    <!-- Book Library Section -->
    <div id="books-library">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="fas fa-book-open me-2 text-primary"></i>Your Book Library</h2>
            
            <div class="d-flex align-items-center">
                <div class="input-group me-3">
                    <input type="text" class="form-control" id="book-search" placeholder="Search books..." aria-label="Search books">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort me-1"></i> Sort
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                        <li><a class="dropdown-item" href="#" data-sort="newest"><i class="fas fa-calendar me-2"></i>Newest First</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="oldest"><i class="fas fa-calendar-alt me-2"></i>Oldest First</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="name"><i class="fas fa-sort-alpha-down me-2"></i>Name</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="pages"><i class="fas fa-file-alt me-2"></i>Page Count</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        {% if books %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 book-cards">
                {% for book in books %}
                    <div class="col">                        <div class="card h-100 book-card hover-shadow" data-title="{{ book.get_display_name }}" data-date="{{ book.uploaded_at|date:'Y-m-d' }}" data-pages="{{ book.page_count }}">
                            <!-- Enhanced Card Header -->
                            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center py-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-book text-white me-2"></i>
                                    <span class="fw-medium">{{ book.page_count }} pages</span>
                                </div>
                                <div class="text-end">
                                    <div class="small">
                                        <i class="far fa-calendar-alt me-1"></i> {{ book.uploaded_at|date:"M d" }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body d-flex flex-column">
                                <!-- Custom Badge for Custom Named Books -->
                                {% if book.custom_name and book.custom_name != book.title %}
                                    <div class="mb-2">
                                        <span class="badge bg-info">
                                            <i class="fas fa-tag me-1"></i>Custom Name
                                        </span>
                                    </div>
                                {% endif %}
                                
                                <h5 class="card-title fw-bold book-title text-primary mb-2">{{ book.get_display_name }}</h5>
                                
                                {% if book.custom_name and book.custom_name != book.title %}
                                    <p class="text-muted small mb-2">
                                        <i class="fas fa-file-alt me-1"></i>Original: {{ book.title }}
                                    </p>
                                {% endif %}
                                
                                <!-- Book Stats Row -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <i class="fas fa-clock text-primary"></i>
                                            <div class="small fw-bold">{{ book.page_count|intdiv:2 }}m</div>
                                            <div class="small text-muted">read</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <i class="fas fa-layer-group text-success"></i>
                                            <div class="small fw-bold">{{ book.chapters.count }}</div>
                                            <div class="small text-muted">chapters</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <i class="fas fa-robot text-warning"></i>
                                            <div class="small fw-bold">{{ book.preferred_model|slice:":7" }}</div>
                                            <div class="small text-muted">AI</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Main Action Button -->
                                <div class="mt-auto">
                                    <a href="{% url 'view_book' book.id %}" class="btn btn-primary w-100 mb-2">
                                        <i class="fas fa-comments me-2"></i>Start Chat
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Enhanced Footer with Better Action Buttons -->
                            <div class="card-footer bg-white border-top-0">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm book-info" 
                                            data-book-id="{{ book.id }}" data-bs-toggle="tooltip" title="Book Information">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="d-none d-sm-inline ms-1">Info</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm quick-question" 
                                            data-book-id="{{ book.id }}" data-bs-toggle="tooltip" title="Quick Question">
                                        <i class="fas fa-comment-dots"></i>
                                        <span class="d-none d-sm-inline ms-1">Ask</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm book-settings" 
                                            data-book-id="{{ book.id }}" data-bs-toggle="tooltip" title="Book Settings">
                                        <i class="fas fa-cog"></i>
                                        <span class="d-none d-sm-inline ms-1">Settings</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-books fa-3x text-muted mb-3"></i>
                <h4>Your library is empty</h4>
                <p class="text-muted">Upload your first book to get started!</p>
                <a href="#upload-section" class="btn btn-primary mt-2">
                    <i class="fas fa-upload me-2"></i>Upload a Book
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show toast notifications instead of alerts
    function showToast(message, type) {
        const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
        const toast = `
            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                <div class="toast align-items-center ${toastClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        `;
        
        $(toast).appendTo('body');
        const toastEl = $('.toast').last();
        const toastObj = new bootstrap.Toast(toastEl, { delay: 3000 });
        toastObj.show();
        
        setTimeout(() => {
            toastEl.parent().remove();
        }, 3500);
    }

    // API Settings form submission with improved UX
    $('#api-settings-form').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalBtnText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...').prop('disabled', true);
        
        var apiKey = $('#groq-api-key').val().trim();
        var modelName = $('#model-select').val();
        
        $.ajax({
            url: '{% url "update_api_settings" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                groq_api_key: apiKey,
                model_name: modelName
            }),
            success: function(response) {                // Reset button
                submitBtn.html(originalBtnText).prop('disabled', false);
                
                if (response.status === 'success') {
                    showToast('API settings saved successfully!', 'success');
                } else {
                    showToast('Error: ' + response.message, 'error');
                }
            },
            error: function() {
                // Reset button
                submitBtn.html(originalBtnText).prop('disabled', false);
                showToast('An error occurred while saving settings.', 'error');
            }
        });
    });
    
    // Toggle password visibility for API key input
    $('.toggle-password').click(function() {
        const input = $(this).closest('.input-group').find('input');
        const icon = $(this).find('i');
        
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });
    
    // File upload with progress simulation
    $('#upload-form').on('submit', function(e) {
        // Don't prevent default - we want the actual form submission to happen
        const progressBar = $('#upload-progress');
        progressBar.removeClass('d-none');
        
        // Show progress bar animation
        const bar = progressBar.find('.progress-bar');
        bar.css('width', '0%');
        
        // Simulate progress - in a real implementation this should use actual upload progress events
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.floor(Math.random() * 10) + 1;
            if (progress > 95) {
                progress = 95; // Let the actual completion finish it
                clearInterval(interval);
            }
            bar.css('width', progress + '%').attr('aria-valuenow', progress);
        }, 300);
    });
    
    // Book search functionality
    $('#book-search').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        
        $('.book-card').each(function() {
            const title = $(this).data('title').toLowerCase();
            if (title.includes(searchTerm)) {
                $(this).closest('.col').show();
            } else {
                $(this).closest('.col').hide();
            }
        });
    });
    
    // Book sorting functionality
    $('.dropdown-item[data-sort]').click(function(e) {
        e.preventDefault();
        const sortBy = $(this).data('sort');
        const container = $('.book-cards');
        const items = container.children('.col').get();
        
        items.sort(function(a, b) {
            const cardA = $(a).find('.book-card');
            const cardB = $(b).find('.book-card');
            
            switch(sortBy) {
                case 'newest':
                    return new Date($(cardB).data('date')) - new Date($(cardA).data('date'));
                case 'oldest':
                    return new Date($(cardA).data('date')) - new Date($(cardB).data('date'));
                case 'name':
                    return $(cardA).data('title').localeCompare($(cardB).data('title'));
                case 'pages':
                    return $(cardB).data('pages') - $(cardA).data('pages');
                default:
                    return 0;
            }
        });
        
        $.each(items, function(i, item) {
            container.append(item);
        });
    });
      // Book info button handler
    $('.book-info').click(function() {
        const bookId = $(this).data('book-id');
        const card = $(this).closest('.book-card');
        const title = card.data('title');
        const pages = card.data('pages');
        const date = card.data('date');
        
        // Get additional book information via AJAX
        $.ajax({
            url: `/api/book-info/${bookId}/`,
            type: 'GET',
            success: function(bookData) {
                const modal = `
                    <div class="modal fade" id="bookInfoModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-info-circle me-2"></i>Book Information
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4 class="text-primary mb-3">${bookData.display_name || title}</h4>
                                            ${bookData.custom_name && bookData.custom_name !== bookData.original_title ? 
                                                `<p class="text-muted mb-3"><strong>Original Title:</strong> ${bookData.original_title}</p>` : ''}
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6">
                                                    <div class="info-item">
                                                        <i class="fas fa-file-alt text-primary me-2"></i>
                                                        <strong>Pages:</strong> ${pages}
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <div class="info-item">
                                                        <i class="fas fa-clock text-primary me-2"></i>
                                                        <strong>Reading Time:</strong> ~${Math.round(pages/2)} minutes
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6">
                                                    <div class="info-item">
                                                        <i class="fas fa-calendar-plus text-primary me-2"></i>
                                                        <strong>Uploaded:</strong> ${new Date(date).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <div class="info-item">
                                                        <i class="fas fa-clock text-primary me-2"></i>
                                                        <strong>Last Updated:</strong> ${new Date(bookData.updated_at || date).toLocaleDateString()}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="info-item">
                                                    <i class="fas fa-folder text-primary me-2"></i>
                                                    <strong>File Location:</strong> 
                                                    <code class="ms-2">${bookData.file_path || 'Not available'}</code>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="info-item">
                                                    <i class="fas fa-layer-group text-primary me-2"></i>
                                                    <strong>Chapters Detected:</strong> ${bookData.chapter_count || 'Processing...'}
                                                </div>
                                            </div>
                                            
                                            ${bookData.processing_status ? `
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Status:</strong> ${bookData.processing_status}
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-book fa-3x text-primary mb-3"></i>
                                                    <h6 class="card-title">Quick Stats</h6>
                                                    <div class="d-grid gap-2">
                                                        <div class="bg-white p-2 rounded">
                                                            <small class="text-muted">File Size</small>
                                                            <div class="fw-bold">${bookData.file_size || 'Unknown'}</div>
                                                        </div>
                                                        <div class="bg-white p-2 rounded">
                                                            <small class="text-muted">Format</small>
                                                            <div class="fw-bold">PDF</div>
                                                        </div>
                                                        <div class="bg-white p-2 rounded">
                                                            <small class="text-muted">AI Model</small>
                                                            <div class="fw-bold">${bookData.preferred_model || 'Default'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="location.href='/book/${bookId}/'">
                                        <i class="fas fa-comments me-1"></i>Start Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $(modal).appendTo('body');
                const modalEl = $('#bookInfoModal');
                const modalObj = new bootstrap.Modal(modalEl);
                modalObj.show();
                
                modalEl.on('hidden.bs.modal', function () {
                    modalEl.remove();
                });
            },
            error: function() {
                // Fallback to basic info if AJAX fails
                const modal = `
                    <div class="modal fade" id="bookInfoModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-info-circle me-2"></i>Book Information
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h4 class="text-primary mb-3">${title}</h4>
                                    <p><strong>Pages:</strong> ${pages}</p>
                                    <p><strong>Upload Date:</strong> ${date}</p>
                                    <p><strong>Estimated Reading Time:</strong> ${Math.round(pages/2)} minutes</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $(modal).appendTo('body');
                const modalEl = $('#bookInfoModal');
                const modalObj = new bootstrap.Modal(modalEl);
                modalObj.show();
                
                modalEl.on('hidden.bs.modal', function () {
                    modalEl.remove();
                });
            }
        });
    });    // Book settings button handler
    $('.book-settings').click(function() {
        const bookId = $(this).data('book-id');
        const card = $(this).closest('.book-card');
        const title = card.find('.book-title').text();
        
        // Get current book settings
        $.ajax({
            url: `/api/book-settings/${bookId}/`,
            type: 'GET',
            success: function(bookData) {
                const settingsModal = `
                    <div class="modal fade" id="bookSettingsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-cog me-2"></i>Book Settings & Management
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="fw-bold mb-3">${title}</h6>
                                            
                                            <!-- Book Title Settings -->
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Book Title</h6>
                                                </div>
                                                <div class="card-body">
                                                    <form id="rename-form-${bookId}">
                                                        <div class="mb-3">
                                                            <label class="form-label">Custom Title</label>
                                                            <input type="text" class="form-control" id="new-title-${bookId}" 
                                                                   value="${bookData.custom_name || bookData.title}" 
                                                                   placeholder="Enter custom title">
                                                            <small class="text-muted">Original: ${bookData.original_title || bookData.title}</small>
                                                        </div>
                                                        <button type="button" class="btn btn-primary btn-sm" onclick="updateBookTitle(${bookId})">
                                                            <i class="fas fa-save me-1"></i>Update Title
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            
                                            <!-- AI Model Settings -->
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Model Preferences</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Preferred AI Model</label>
                                                        <select class="form-select" id="ai-model-${bookId}">
                                                            <option value="llama-3.3-70b-versatile" ${bookData.preferred_model === 'llama-3.3-70b-versatile' ? 'selected' : ''}>Llama 3.3 70B (Recommended)</option>
                                                            <option value="llama-3.1-8b-instant" ${bookData.preferred_model === 'llama-3.1-8b-instant' ? 'selected' : ''}>Llama 3.1 8B (Fast)</option>
                                                            <option value="gemma2-9b-it" ${bookData.preferred_model === 'gemma2-9b-it' ? 'selected' : ''}>Gemma2 9B</option>
                                                            <option value="mixtral-8x7b-32768" ${bookData.preferred_model === 'mixtral-8x7b-32768' ? 'selected' : ''}>Mixtral 8x7B</option>
                                                        </select>
                                                    </div>
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="updateAIModel(${bookId})">
                                                        <i class="fas fa-save me-1"></i>Update Model
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <!-- Quick Actions -->
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-grid gap-2">
                                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="downloadBook(${bookId})">
                                                            <i class="fas fa-download me-2"></i>Download PDF
                                                        </button>
                                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="exportBookData(${bookId})">
                                                            <i class="fas fa-file-export me-2"></i>Export Chat History
                                                        </button>
                                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="reprocessBook(${bookId})">
                                                            <i class="fas fa-sync me-2"></i>Reprocess Book
                                                        </button>
                                                        <hr>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteBook(${bookId})">
                                                            <i class="fas fa-trash me-2"></i>Delete Book
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Statistics -->
                                            <div class="card mt-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Usage Stats</h6>
                                                </div>
                                                <div class="card-body">
                                                    <small class="text-muted">Questions Asked:</small>
                                                    <div class="fw-bold">${bookData.question_count || 0}</div>
                                                    <small class="text-muted mt-2 d-block">Last Chat:</small>
                                                    <div class="fw-bold">${bookData.last_chat || 'Never'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="location.href='/book/${bookId}/'">
                                        <i class="fas fa-comments me-1"></i>Open Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $(settingsModal).appendTo('body');
                const modalEl = $('#bookSettingsModal');
                const modalObj = new bootstrap.Modal(modalEl);
                modalObj.show();
                
                modalEl.on('hidden.bs.modal', function () {
                    modalEl.remove();
                });
            },
            error: function() {
                // Fallback settings modal
                const settingsModal = `
                    <div class="modal fade" id="bookSettingsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-cog me-2"></i>Book Settings
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h6 class="fw-bold mb-3">${title}</h6>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="renameBook(${bookId})">
                                            <i class="fas fa-edit me-2"></i>Rename Book
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="downloadBook(${bookId})">
                                            <i class="fas fa-download me-2"></i>Download PDF
                                        </button>
                                        <hr>
                                        <button type="button" class="btn btn-danger" onclick="deleteBook(${bookId})">
                                            <i class="fas fa-trash me-2"></i>Delete Book
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $(settingsModal).appendTo('body');
                const modalEl = $('#bookSettingsModal');
                const modalObj = new bootstrap.Modal(modalEl);
                modalObj.show();
                
                modalEl.on('hidden.bs.modal', function () {
                    modalEl.remove();
                });
            }
        });
    });
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $(settingsModal).appendTo('body');
        const modalEl = $('#bookSettingsModal');
        const modalObj = new bootstrap.Modal(modalEl);
        modalObj.show();
        
        modalEl.on('hidden.bs.modal', function () {
            modalEl.remove();
        });
    });
      // Quick question button handler
    $('.quick-question').click(function() {
        const bookId = $(this).data('book-id');
        const bookTitle = $(this).closest('.book-card').find('.book-title').text();
        
        // Create and show quick question modal
        const quickQuestionModal = `
            <div class="modal fade" id="quickQuestionModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-comment-dots me-2"></i>Quick Question
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h6 class="text-info mb-3">${bookTitle}</h6>
                            <div class="mb-3">
                                <label for="quick-question-input" class="form-label">What would you like to ask about this book?</label>
                                <textarea class="form-control" id="quick-question-input" rows="3" 
                                         placeholder="e.g., What is the main theme of this book?"></textarea>
                            </div>
                            
                            <!-- Suggested Questions -->
                            <div class="mb-3">
                                <label class="form-label">Suggested Questions:</label>
                                <div class="d-flex flex-wrap gap-1">
                                    <button type="button" class="btn btn-outline-secondary btn-sm suggest-question" 
                                            data-question="What is the main theme of this book?">Main Theme</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm suggest-question" 
                                            data-question="Can you summarize this book?">Summary</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm suggest-question" 
                                            data-question="Who are the main characters?">Characters</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm suggest-question" 
                                            data-question="What are the key takeaways?">Key Points</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-info" onclick="submitQuickQuestion(${bookId})">
                                <i class="fas fa-paper-plane me-1"></i>Ask Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $(quickQuestionModal).appendTo('body');
        const modalEl = $('#quickQuestionModal');
        const modalObj = new bootstrap.Modal(modalEl);
        modalObj.show();
        
        // Handle suggested question clicks
        $('.suggest-question').click(function() {
            const question = $(this).data('question');
            $('#quick-question-input').val(question);
        });
        
        modalEl.on('hidden.bs.modal', function () {
            modalEl.remove();
        });
    });
    
    // Toggle password visibility
    $('.toggle-password').click(function() {
        var passwordInput = $('#groq-api-key');
        var icon = $(this).find('i');
        
        if (passwordInput.attr('type') === 'password') {
            passwordInput.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            passwordInput.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });

    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        
        var form = $(this);
        var formData = new FormData(form[0]);
        
        // Show progress bar
        $('#upload-progress').removeClass('d-none');
        
        $.ajax({
            url: '{% url "upload_book" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        $('.progress-bar').css('width', percentComplete * 100 + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.status === 'success') {
                    window.location.href = '/book/' + response.book_id + '/';
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Upload failed. Please try again.');            },
            complete: function() {
                $('#upload-progress').addClass('d-none');
                $('.progress-bar').css('width', '0%');
            }
        });
    });
});

// Helper functions for book operations
function deleteBook(bookId) {
    if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
        $.ajax({
            url: '/book/' + bookId + '/delete/',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Remove the book card from the DOM
                    $('[data-book-id="' + bookId + '"]').closest('.col').fadeOut(300, function() {
                        $(this).remove();
                        // Hide modal
                        $('#bookSettingsModal').modal('hide');
                        // Show success message
                        showToast('Book deleted successfully!', 'success');
                    });
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Failed to delete book. Please try again.');
            }
        });
    }
}

function renameBook(bookId) {    const currentName = $('[data-book-id="' + bookId + '"]').closest('.book-card').find('.book-title').text();
    const newName = prompt('Enter new name for the book:', currentName);
    
    if (newName && newName.trim() !== '' && newName !== currentName) {
        $.ajax({
            url: '/book/' + bookId + '/rename/',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: {
                'new_name': newName.trim()
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the book title in the card
                    $('[data-book-id="' + bookId + '"]').closest('.book-card').find('.book-title').text(newName.trim());
                    // Hide modal
                    $('#bookSettingsModal').modal('hide');
                    // Show success message
                    showToast('Book renamed successfully!', 'success');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Failed to rename book. Please try again.');
            }
        });
    }
}

function downloadBook(bookId) {
    window.open('/book/' + bookId + '/download/', '_blank');
}

// New enhanced functions for improved UI
function updateBookTitle(bookId) {
    const newTitle = $('#new-title-' + bookId).val().trim();
    
    if (!newTitle) {
        alert('Please enter a valid title.');
        return;
    }
    
    $.ajax({
        url: `/api/book-update/${bookId}/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        data: {
            'custom_name': newTitle,
            'action': 'update_title'
        },
        success: function(response) {
            if (response.status === 'success') {
                // Update the book title in the card
                $(`[data-book-id="${bookId}"]`).closest('.book-card').find('.book-title').text(newTitle);
                showToast('Book title updated successfully!', 'success');
                $('#bookSettingsModal').modal('hide');
                // Refresh the page to show updated title
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('Failed to update book title. Please try again.');
        }
    });
}

function updateAIModel(bookId) {
    const newModel = $('#ai-model-' + bookId).val();
    
    $.ajax({
        url: `/api/book-update/${bookId}/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        data: {
            'preferred_model': newModel,
            'action': 'update_model'
        },
        success: function(response) {
            if (response.status === 'success') {
                showToast('AI model updated successfully!', 'success');
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('Failed to update AI model. Please try again.');
        }
    });
}

function exportBookData(bookId) {
    window.open(`/api/book-export/${bookId}/`, '_blank');
    showToast('Exporting book data...', 'info');
}

function reprocessBook(bookId) {
    if (confirm('This will reprocess the book and may take some time. Continue?')) {
        $.ajax({
            url: `/api/book-reprocess/${bookId}/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    showToast('Book reprocessing started. Please wait...', 'info');
                    $('#bookSettingsModal').modal('hide');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Failed to start reprocessing. Please try again.');
            }
        });
    }
}

function deleteBook(bookId) {
    const bookTitle = $(`[data-book-id="${bookId}"]`).closest('.book-card').find('.book-title').text();
    
    if (confirm(`Are you sure you want to delete "${bookTitle}"? This action cannot be undone.`)) {
        $.ajax({
            url: `/api/book-delete/${bookId}/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Remove the book card from DOM
                    $(`[data-book-id="${bookId}"]`).closest('.col').fadeOut(300, function() {
                        $(this).remove();
                        
                        // Check if library is empty
                        if ($('.book-card').length === 0) {
                            location.reload();
                        }
                    });
                    
                    showToast('Book deleted successfully!', 'success');
                    $('#bookSettingsModal').modal('hide');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Failed to delete book. Please try again.');
            }
        });
    }
}

// Improved Quick Question handler
function handleQuickQuestion(bookId) {
    const question = prompt('What would you like to ask about this book?');
    
    if (question && question.trim()) {
        // Store question and redirect to chat
        sessionStorage.setItem('quickQuestion', question.trim());
        window.location.href = `/book/${bookId}/`;
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    
    const toast = `
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" id="${toastId}" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    $('body').append(toast);
    const toastEl = $('#' + toastId);
    const bsToast = new bootstrap.Toast(toastEl);
    bsToast.show();
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toastEl.remove();
    }, 3000);
}

// Submit quick question function
function submitQuickQuestion(bookId) {
    const question = $('#quick-question-input').val().trim();
    
    if (!question) {
        alert('Please enter a question.');
        return;
    }
    
    // Store question and redirect to chat
    sessionStorage.setItem('quickQuestion', question);
    window.location.href = `/book/${bookId}/`;
}
</script>
{% endblock %}
{% endblock %}
